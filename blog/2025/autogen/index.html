<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>—layout: post title: Microsoft 에서 만든 Multi-Agent framework, AutoGen date: 2025-01-10 10:00:00 giscus_comments: true categories: framework toc: beginning: true sidebar: left tags: LLM agent WIP Microsoft —</p> <h2 id="agent-사용법">Agent 사용법</h2> <h3 id="응답-받기">응답 받기</h3> <p><code class="language-plaintext highlighter-rouge">on_messages()</code> 함수를 이용해서 에이전트의 응답(<code class="language-plaintext highlighter-rouge">response</code>)을 받을 수 있다.</p> <p>이때 응답은 <code class="language-plaintext highlighter-rouge">response.inner_messages</code> 와 <code class="language-plaintext highlighter-rouge">response.chat_message</code> 를 포함한다.</p> <ul> <li> <code class="language-plaintext highlighter-rouge">inner_messages</code> 는 에이전트의 “thought process” 를 저장한다.</li> <li> <code class="language-plaintext highlighter-rouge">chat_message</code> 는 에이전트의 최종 응답을 포함한다.</li> </ul> <p>아래는 agent 의 <code class="language-plaintext highlighter-rouge">on_messages()</code> 호출 예시이다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">assistant_run</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="p">.</span><span class="nf">on_messages</span><span class="p">(</span>
        <span class="p">[</span><span class="nc">TextMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">"</span><span class="s">Find information on AutoGen</span><span class="sh">"</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">)],</span>
        <span class="n">cancellation_token</span><span class="o">=</span><span class="nc">CancellationToken</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">inner_messages</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">chat_message</span><span class="p">)</span>


<span class="c1"># Use asyncio.run(assistant_run()) when running in a script.
</span><span class="k">await</span> <span class="nf">assistant_run</span><span class="p">()</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">cancellation_token</code> 을 이용해서 언제 취소되는지 명시적으로 지정해주는걸 알 수 있다.</p> <p>주의할 점은 이 <code class="language-plaintext highlighter-rouge">on_messages()</code> 함수는 agent의 inner state를 변경하므로, 동일한 메시지나 히스토리를 입력으로 사용하면 안된다는 점이다.</p> <h3 id="도구-호출">도구 호출</h3> <p>AgentChat에서 <code class="language-plaintext highlighter-rouge">AssistantAgent</code>는 웹 검색 도구와 같은 tool 을 사용하여 특정 작업을 수행할 수 있으며, 이러한 tool 은 Python 함수나 <code class="language-plaintext highlighter-rouge">BaseTool</code>의 하위 클래스로 구현될 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">agent</span> <span class="o">=</span> <span class="nc">AssistantAgent</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">tool</span><span class="p">],</span> 
    <span class="n">model_client</span><span class="o">=</span><span class="n">model_client</span><span class="p">,</span> 
    <span class="n">system_message</span><span class="o">=</span><span class="sh">"</span><span class="s">Use the `df` variable to access the dataset.</span><span class="sh">"</span>
<span class="p">)</span>
</code></pre></div></div> <h2 id="multi-agent-team-사용법">Multi-Agent (Team) 사용법</h2> <p><code class="language-plaintext highlighter-rouge">RoundRobinGroupChat</code> 은 모든 에이전트가 동일한 맥락을 공유하고 돌아가면서 응답하는 간단하면서도 효과적인 팀 구성 방식이다. 각 에이전트는 자신의 차례가 되면 다른 모든 에이전트에게 응답을 방송하여 팀 전체가 일관된 맥락을 유지할 수 있도록 해준다.</p> <p>2개의 에이전트로 시(poem)를 쓰는 팀을 만든다고 가정해보자. 한 에이전트는 시를 작성하고, 다른 하나는 작성된 시를 평가한다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create the primary agent.
</span><span class="n">primary_agent</span> <span class="o">=</span> <span class="nc">AssistantAgent</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">primary</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">model_client</span><span class="o">=</span><span class="n">model_client</span><span class="p">,</span>
    <span class="n">system_message</span><span class="o">=</span><span class="sh">"</span><span class="s">You are a helpful AI assistant.</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create the critic agent.
</span><span class="n">critic_agent</span> <span class="o">=</span> <span class="nc">AssistantAgent</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">critic</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">model_client</span><span class="o">=</span><span class="n">model_client</span><span class="p">,</span>
    <span class="n">system_message</span><span class="o">=</span><span class="sh">"</span><span class="s">Provide constructive feedback. Respond with </span><span class="sh">'</span><span class="s">APPROVE</span><span class="sh">'</span><span class="s"> to when your feedbacks are addressed.</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Define a termination condition that stops the task if the critic approves.
</span><span class="n">text_termination</span> <span class="o">=</span> <span class="nc">TextMentionTermination</span><span class="p">(</span><span class="sh">"</span><span class="s">APPROVE</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Create a team with the primary and critic agents.
</span><span class="n">team</span> <span class="o">=</span> <span class="nc">RoundRobinGroupChat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">primary_agent</span><span class="p">,</span> <span class="n">critic_agent</span><span class="p">],</span> 
    <span class="n">termination_condition</span><span class="o">=</span><span class="n">text_termination</span>
<span class="p">)</span>
</code></pre></div></div> <p>이렇게 되면 아래와 같이 <code class="language-plaintext highlighter-rouge">APPROVE</code> 라는 메시지가 나올때까지 둘이 핑퐁하며 시를 쓰게 된다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- user ----------
Write a short poem about the fall season.
---------- primary ----------
Golden leaves in crisp air dance,  
---------- critic ----------
Your poem beautifully captures the essence of the fall season
...
---------- primary ----------
Thank you for your thoughtful feedback! I
...
---------- critic ----------
APPROVE
...
---------- Summary ----------
Number of messages: 5
Finish reason: Text 'APPROVE' mentioned
Total prompt tokens: 972
Total completion tokens: 455
Duration: 11.78 seconds
</code></pre></div></div> <h2 id="종료-조건">종료 조건</h2> <p>AutoGen 에서는 이런 Team 이 동작중일때 종료하는 것을 상당히 신경쓴것으로 보인다. 외부에서는 특정 함수 호출로 team 동작을 정지시키거나, 내부에서는 termination text(또는 token) 을 지정해줄 수 있다.</p> <p>특히 지원되는 내부적 종료 조건이 상당히 많다.</p> <ul> <li> <code class="language-plaintext highlighter-rouge">MaxMessageTermination</code>: 에이전트 및 작업 메시지를 포함하여 지정된 수의 메시지가 생성된 후 중지</li> <li> <code class="language-plaintext highlighter-rouge">TextMentionTermination</code>: 메시지에서 특정 텍스트 또는 문자열이 언급될 때 중지</li> <li> <code class="language-plaintext highlighter-rouge">SourceMatchTermination</code>: 특정 에이전트가 응답한 후 중지</li> </ul> <p>이러한 컨디션들을 <code class="language-plaintext highlighter-rouge">&amp;</code> 나 <code class="language-plaintext highlighter-rouge">|</code> 로 조합해서 사용할 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">max_msg_termination</span> <span class="o">=</span> <span class="nc">MaxMessageTermination</span><span class="p">(</span><span class="n">max_messages</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">text_termination</span> <span class="o">=</span> <span class="nc">TextMentionTermination</span><span class="p">(</span><span class="sh">"</span><span class="s">APPROVE</span><span class="sh">"</span><span class="p">)</span>
<span class="n">combined_termination</span> <span class="o">=</span> <span class="n">max_msg_termination</span> <span class="o">|</span> <span class="n">text_termination</span>
</code></pre></div></div> <h2 id="appendix">Appendix</h2> <p>AgentChat 은 에이전트 내부의 이벤트를 나타내는 메시지 개념도 지원</p> <ul> <li>도구 호출 요청을 나타내는 <code class="language-plaintext highlighter-rouge">ToolCallRequestEvent</code> </li> <li>도구 호출 결과를 포함하는 <code class="language-plaintext highlighter-rouge">ToolCallExecutionEvent</code> </li> </ul> </body></html>